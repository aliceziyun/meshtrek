apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.22.0 (955b78124)
  labels:
    io.kompose.service: frontend
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: frontend
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert
        kompose.version: 1.22.0 (955b78124)
        sidecar.istio.io/statsInclusionPrefixes: cluster.outbound,cluster_manager,listener_manager,http_mixer_filter,tcp_mixer_filter,server,cluster.xds-grp,listener,connection_manager
        sidecar.istio.io/statsInclusionRegexps: http.*
      labels:
        io.kompose.service: frontend
    spec:
      containers:
        # =========================
        # Main application
        # =========================
        - name: hotel-reserv-frontend
          image: docker.io/alicesong2002/hotel-reservation-modified:v1.2
          command:
            - /go/bin/frontend
          securityContext:
            allowPrivilegeEscalation: true
            privileged: true
            capabilities:
              add: ["SYS_ADMIN"]
          ports:
            - containerPort: 5000

        # =========================
        # OPA sidecar (ALLOW ALL)
        # =========================
        - name: opa
          image: openpolicyagent/opa:0.63.0
          args:
            - "run"
            - "--server"
            - "--log-level=info"
            - "--set=plugins.envoy_ext_authz_grpc.addr=:9191"
            - "--set=plugins.envoy_ext_authz_grpc.path=istio/authz/allow"
            - "/policy"
          ports:
            - containerPort: 9191
              name: grpc
          volumeMounts:
            - name: opa-policy
              mountPath: /policy
          resources:
            requests:
              memory: "256Mi"
            limits:
              memory: "256Mi"

        # =========================
        # Istio proxy (existing)
        # =========================
        - name: istio-proxy
          image: docker.io/alicesong2002/modified_istio_proxy:v15.0
          securityContext:
            allowPrivilegeEscalation: true
            privileged: true
            capabilities:
              add: ["SYS_ADMIN"]
          volumeMounts:
            - mountPath: /lib/modules
              name: lib-modules
            - mountPath: /usr/src
              name: linux-headers
            - mountPath: /tmp
              name: tmp
          resources:
            requests:
              memory: "3000Mi"
            limits:
              memory: "3000Mi"

      volumes:
        - name: tmp
          emptyDir: {}
        - name: lib-modules
          hostPath:
            path: /lib/modules
            type: Directory
        - name: linux-headers
          hostPath:
            path: /usr/src
            type: Directory
        - name: opa-policy
          configMap:
            name: opa-policy

      restartPolicy: Always
